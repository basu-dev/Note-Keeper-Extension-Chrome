const d=document,htmlParser=new DOMParser;let notes=[],firstPage,secondPage,firstPageCloseBtn,secondPageCloseBtn,backupBtn,textarea,restoreBtn,noteCards,deleteAllBtn,input,fileInput,closeFileInputBtn,count,searchBox,url;const select=sel=>d.querySelector(sel),add=(element,eventtype,cb)=>element.addEventListener(eventtype,cb),css=(element,style)=>Object.keys(style).forEach(key=>element.style[key]=style[key]);add(d,"DOMContentLoaded",()=>{firstPage=select(".first-page"),secondPage=select(".second-page"),firstPageCloseBtn=select("#open-notes"),secondPageCloseBtn=select("#second-page-close"),backupBtn=select("#backup"),deleteAllBtn=select("#delete-all"),textarea=select("textarea"),input=select("input"),noteCards=select(".cards"),restoreBtn=select("#restore"),fileInput=select("input[type=file]"),closeFileInputBtn=select("#close-file-input"),buttonsDiv=select(".sec-page-btns"),fileInputDiv=select("#file-input"),searchBox=select("#search"),chrome.tabs.query({currentWindow:!0,active:!0},(function(tabs){url=new URL(tabs[0].url).origin})),add(firstPageCloseBtn,"click",_=>showFirstPage(!1)),add(secondPageCloseBtn,"click",_=>newNote()),add(textarea,"keyup",e=>saveNote()),add(textarea,"paste",e=>saveNote()),add(input,"keyup",e=>saveNote()),add(backupBtn,"click",_=>backupNotes()),add(restoreBtn,"click",_=>showFileInputDiv(!0)),add(closeFileInputBtn,"click",_=>showFileInputDiv(!1)),add(deleteAllBtn,"click",_=>deleteAllNotes()),add(fileInput,"change",e=>getBackupFromFile(e)),add(searchBox,"keyup",e=>search(e.target.value)),showFirstPage(!1)});const newNote=()=>{textarea.value="",textarea.setAttribute("note-id",""),input.value="",showFirstPage(!0)},showFileInputDiv=truth=>{if(truth)return css(fileInputDiv,{display:"block"}),void css(buttonsDiv,{display:"none"});css(fileInputDiv,{display:"none"}),fileInput.value="",css(buttonsDiv,{display:"block"})},showFirstPage=truth=>{truth?(firstPage.style.display="grid",secondPage.style.display="none"):(loadNotes(),firstPage.style.display="none",secondPage.style.display="grid")},saveNote=async()=>{let body=textarea.value,title=input.value,id=textarea.getAttribute("note-id");""==id.trim()&&(id=Date.now(),textarea.setAttribute("note-id",id)),console.log(id);let key=`Notes ${id}`;if(""==body.trim()&&""==title.trim())return void deleteNote(key);let data=await getNote(key)?await getNote(key):{};data[key]={title:title,body:body,url:url},chrome.storage.sync.set(data,res=>{})},getNote=key=>new Promise((resolve,reject)=>{chrome.storage.sync.get(key,data=>{resolve(data)})}),fillTextarea=async id=>{let{body:body,title:title}=notes.filter(n=>n.id==id)[0];textarea.value=body,textarea.setAttribute("note-id",id),input.value=title},loadNotes=async()=>showNotes(await getNotes()),getNotes=()=>new Promise(resolve=>{count=0,chrome.storage.sync.get(null,data=>{notes=[],Object.keys(data).forEach(key=>{if(/Notes (.)+/.test(key)){count++;let note={id:/Notes (.+)/.exec(key)[1],url:data[key].url,title:data[key].title,body:data[key].body};notes.unshift(note)}}),resolve(notes)})}),search=word=>{let reg=new RegExp(word,"i");tempNotes=[],""!=word.trim()?(notes.forEach(({id:id,url:url,title:title,body:body})=>{(reg.test(url)||reg.test(title)||reg.test(body))&&tempNotes.push({id:id,url:url,title:title,body:body})}),showNotes(tempNotes)):showNotes(notes)},deleteNote=key=>{/^Notes .+$/.test(key)&&chrome.storage.sync.remove(key,_=>loadNotes())},deleteAllNotes=_=>{confirm("Do You Want To Delete All Notes?")&&chrome.storage.sync.get(null,data=>{Object.keys(data).forEach(key=>deleteNote(key)),loadNotes()})},showNotes=notes=>{const countArea=select("h3 small");countArea.innerText=count,noteCards.innerHTML="";for(let i=0;i<notes.length;i++){let note=notes[i],html=htmlParser.parseFromString(`\n              <div class="card">\n                  <div class="card-header"><a href="${note.url}">${note.url}</a><span><small></small><button note-id="${note.id}">Edit</button> <button id="${note.id}">Del</button></span></div>\n                  <div class="card-title">${note.title}</div>\n                  <pre class="card-body">${note.body}</pre>\n              </div>\n          `,"text/html").querySelector(".card");html.querySelector("button[id]").addEventListener("click",e=>{confirm("Do you want to delete  this note?")&&deleteNote(`Notes ${e.target.id}`)}),html.querySelector("button[note-id]").addEventListener("click",e=>{fillTextarea(e.target.getAttribute("note-id")),showFirstPage(!0)});let time=getAppropriateTime(parseInt(note.id));html.querySelector("small").innerText=time;const timeSection=html.querySelector("div");noteCards.appendChild(html)}},getAppropriateTime=time=>{const date=new Date(time),diff=Date.now()-time,DAY=864e5;if(!(diff<DAY&&diff>0)){if(diff<7*DAY){const[,day,time]=/([\D]+) \D+ .+ (\d+:\d+)/.exec(date);return`${day}, ${time}`}if(diff<364*DAY){const[,day,month]=/([\D]+) ([\D]+ [\d]+)/.exec(date);return`${day}, ${month}`}{const[,month,year]=/[\D]+ ([\D]+ [\d]+) ([\d]+)/.exec(date);return`${month}, ${year}`}}/([\d]+:[\d]+)/.exec(date.toTimeString())[0]},backupNotes=()=>{let a=d.createElement("a"),dt=new Date;a.setAttribute("download",`NotesBackup-${dt.getFullYear()}-${dt.getMonth()}-${dt.getDate()}-${dt.getHours()}-${dt.getMinutes()}-${dt.getSeconds()}.json`),a.href=`data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(notes))}`,a.style.display="none",d.body.append(a),console.log(a),a.click(),select("[download]").remove()},notifier=(msg,type)=>{let text=d.createElement("text");text.outerHTML=`<div class="${type}">`,console.log(text)},reader=new FileReader,getBackupFromFile=e=>{let file=e.target.files[0];"application/json"==file.type&&/^NotesBackup-[\d]+-[\d]+-[\d]+-[\d]+-[\d]+-[\d]+.json$/.test(e.target.files[0].name)&&(reader.readAsText(file,"UTF-8"),reader.onloadend=e=>{console.log(e.target.result);let isValid=!0;["url","title","body"].forEach(x=>{e.target.result.includes(x)||(isValid=!0)}),isValid&&confirm("Are you sure you want to use this backup?")&&(notes=JSON.parse(e.target.result),notes[0].url&&notes[0].body&&notes[0].title&&(notes.forEach(note=>{const{id:id,url:url,body:body,title:title}=note;let data={};data[`Notes ${id}`]={url:url,title:title,body:body},chrome.storage.sync.set(data)}),showFileInputDiv(!1),loadNotes()))})};